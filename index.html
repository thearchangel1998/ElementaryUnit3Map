<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survival Map: Teacher Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Nunito:wght@400;700&display=swap');

        body {
            font-family: 'Nunito', sans-serif;
            background-color: #1a202c;
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: row;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 320px;
            background: #2d3748;
            padding: 15px;
            display: flex;
            flex-direction: column;
            border-right: 4px solid #4a5568;
            box-shadow: 5px 0 15px rgba(0,0,0,0.3);
            z-index: 100;
            overflow-y: auto;
        }

        /* --- MAIN AREA --- */
        #main-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-image: radial-gradient(#2d3748 1px, #1a202c 1px);
            background-size: 20px 20px;
            position: relative;
            padding: 10px;
        }

        /* --- GAME CONTAINER --- */
        #game-container {
            position: relative;
            width: 100%;
            max-width: 1600px;
            aspect-ratio: 16/9;
            background-color: #d1d5db; 
            border: 8px solid #4a5568;
            border-radius: 12px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            user-select: none;
        }

        /* --- BUILDINGS --- */
        .building {
            position: absolute;
            border: 2px solid #4a5568;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1vw; /* Text slightly bigger since no icons */
            font-weight: 800; /* Bolder text */
            color: #2d3748;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            line-height: 1.2;
            padding: 2px;
        }
        
        .building:hover { transform: scale(1.02); z-index: 5; }

        /* Building Colors */
        .b-commercial { background: #ffedd5; border-color: #c2410c; }
        .b-public { background: #fce7f3; border-color: #be185d; }
        .b-service { background: #dbeafe; border-color: #1d4ed8; }
        .b-park { background: #dcfce7; border-color: #15803d; color: #14532d; }
        .b-industrial { background: #f3f4f6; border-color: #4b5563; }
        .b-transport { background: #fff; border-color: #374151; }

        .label-sm { font-size: 0.8vw; }

        /* BLIND MODE STYLES (Hide Text Only) */
        .blind-mode .building {
            font-size: 0 !important;
            color: transparent !important;
        }

        /* Road Names */
        .road-label {
            position: absolute; color: #6b7280; font-weight: bold; font-size: 1.1vw;
            letter-spacing: 2px; text-transform: uppercase; pointer-events: none;
        }
        .road-v { transform: rotate(-90deg); transform-origin: center; }

        /* --- PLAYERS --- */
        .player-token {
            position: absolute;
            width: 6.6%;
            aspect-ratio: 1/1;
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: top 0.05s linear, left 0.05s linear, opacity 0.3s, filter 0.3s;
            z-index: 50;
        }
        .player-token i { font-size: 3.6vw; color: white; }
        
        #player-a { background-color: #2563eb; box-shadow: 0 0 15px #2563eb; }
        #player-b { background-color: #db2777; box-shadow: 0 0 15px #db2777; }

        .player-token.inactive {
            opacity: 0.6; filter: grayscale(0.8); z-index: 40; transform: scale(0.9);
        }

        /* --- OVERLAYS --- */
        .overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(5px);
        }
        #monster-screen { background: rgba(0, 0, 0, 0.95); }
        #win-screen { background: rgba(16, 185, 129, 0.9); }
        .overlay-screen.active { opacity: 1; pointer-events: all; }

        /* --- UI ELEMENTS --- */
        .control-group { margin-bottom: 1rem; background: #4a5568; padding: 12px; border-radius: 10px; border: 1px solid #718096; }
        .scoreboard { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
        
        .team-box { 
            flex: 1; 
            background: #1a202c; 
            border-radius: 8px; 
            padding: 8px; 
            text-align: center; 
            border: 2px solid transparent; 
            opacity: 0.5; 
            transition: all 0.3s;
            position: relative; /* For buttons */
        }
        
        .team-box.team-a.active { opacity: 1; transform: scale(1.05); border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }
        .team-a .team-name { color: #93c5fd; }
        .team-box.team-b.active { opacity: 1; transform: scale(1.05); border-color: #ec4899; box-shadow: 0 0 15px rgba(236, 72, 153, 0.3); }
        .team-b .team-name { color: #f9a8d4; }

        .team-name { font-family: 'Press Start 2P'; font-size: 0.6rem; margin-bottom: 4px; }
        .team-score { font-family: 'Press Start 2P'; font-size: 1.5rem; color: white; margin: 5px 0; }
        
        /* Manual Score Controls */
        .score-ctrl {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 5px;
        }
        .score-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .btn-plus { background: #48bb78; color: white; }
        .btn-plus:hover { background: #38a169; }
        .btn-minus { background: #f56565; color: white; }
        .btn-minus:hover { background: #e53e3e; }

        .mission-select { width: 100%; background: #edf2f7; color: #1a202c; padding: 10px; border-radius: 6px; font-weight: bold; border: 2px solid #cbd5e0; cursor: pointer; font-size: 0.9rem; }
        
        .big-btn { width: 100%; padding: 12px; border-radius: 8px; font-family: 'Press Start 2P', cursive; text-transform: uppercase; cursor: pointer; transition: all 0.1s; border-bottom: 4px solid rgba(0,0,0,0.2); font-size: 0.8rem; text-align: center; }
        .big-btn:disabled { opacity: 0.5; cursor: not-allowed; border-color: transparent; }
        
        .btn-confirm { background: #e53e3e; color: white; border-color: #9b2c2c; }
        .btn-confirm:hover:not(:disabled) { background: #c53030; transform: translateY(-2px); }
        .btn-confirm:active:not(:disabled) { transform: translateY(2px); border-bottom-width: 0; margin-top: 2px; }
        
        .btn-reset { background: #4299e1; color: white; border-color: #2b6cb0; margin-top: 8px; font-size: 0.7rem; padding: 8px;}

        /* Timer Styling */
        #timer-display {
            font-family: 'Press Start 2P', cursive;
            color: #4ade80; text-shadow: 0 0 5px rgba(74, 222, 128, 0.5);
        }
        #timer-display.low-time {
            color: #ef4444; text-shadow: 0 0 5px rgba(239, 68, 68, 0.5);
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .building.highlight-debug { border: 3px dashed red !important; background: rgba(255,0,0,0.2) !important; }
        
        /* Start Button Animation */
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
        }
        .btn-start-pulse {
            animation: pulse-green 2s infinite;
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div id="sidebar">
        <div class="text-center mb-4">
            <h1 class="text-lg font-bold text-yellow-400 font-['Press_Start_2P'] leading-relaxed">SURVIVAL<br>RACING</h1>
        </div>

        <div class="control-group border-l-4 border-purple-500">
            <h3 class="text-gray-300 text-xs uppercase font-bold mb-2 tracking-wider flex justify-between">
                <span>Scoreboard</span>
                <button onclick="resetScores()" class="text-xs text-red-400 hover:text-red-300 underline">Reset Match</button>
            </h3>
            <div class="scoreboard">
                <!-- TEAM A -->
                <div id="box-a" class="team-box team-a active">
                    <div class="team-name">TEAM A</div>
                    <div class="text-xs text-blue-300 mb-1"><i class="fas fa-user-astronaut"></i></div>
                    <div id="score-a" class="team-score">0</div>
                    <!-- Manual Controls -->
                    <div class="score-ctrl">
                        <button onclick="adjustScore('A', -1)" class="score-btn btn-minus"><i class="fas fa-minus"></i></button>
                        <button onclick="adjustScore('A', 1)" class="score-btn btn-plus"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <!-- TEAM B -->
                <div id="box-b" class="team-box team-b">
                    <div class="team-name">TEAM B</div>
                    <div class="text-xs text-pink-300 mb-1"><i class="fas fa-user-ninja"></i></div>
                    <div id="score-b" class="team-score">0</div>
                    <!-- Manual Controls -->
                    <div class="score-ctrl">
                        <button onclick="adjustScore('B', -1)" class="score-btn btn-minus"><i class="fas fa-minus"></i></button>
                        <button onclick="adjustScore('B', 1)" class="score-btn btn-plus"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center mt-2 bg-gray-800 p-2 rounded mb-2">
                <span class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300" id="turn-indicator">Turn: TEAM A</span>
                <div id="timer-display" class="text-lg">02:00</div>
            </div>

            <!-- NEW START TURN BUTTON -->
            <button onclick="startTurn()" id="start-turn-btn" class="w-full bg-green-600 text-white font-bold py-2 rounded text-sm hover:bg-green-500 btn-start-pulse border-b-4 border-green-800 active:border-b-0 active:mt-1">
                ‚ñ∂ START TURN
            </button>
        </div>

        <div class="control-group">
            <h3 class="text-gray-300 text-xs uppercase font-bold mb-2 tracking-wider">Destination</h3>
            <select id="target-select" class="mission-select mb-3">
                <optgroup label="Main Street / Square">
                    <option value="factory">Factory</option>
                    <option value="station">Station</option>
                    <option value="library">Library</option>
                    <option value="cafe">Cafe</option>
                    <option value="main_square">Main Square</option>
                    <option value="government_building">Gov. Building</option>
                    <option value="post_office">Post Office</option>
                    <option value="hotel">Hotel</option>
                    <option value="theatre">Theatre</option>
                </optgroup>
                <optgroup label="Shopping Area">
                    <option value="department_store">Department Store</option>
                    <option value="supermarket">Supermarket</option>
                    <option value="cinema">Cinema</option>
                    <option value="car_park">Car Park</option>
                    <option value="bank">Bank</option>
                    <option value="book_shop">Book Shop</option>
                    <option value="shopping_centre">Shopping Centre</option>
                    <option value="shoe_shop">Shoe Shop</option>
                    <option value="chemist">Chemist</option>
                </optgroup>
                <optgroup label="Recreation Area">
                    <option value="central_park">Central Park</option>
                    <option value="museum">Museum</option>
                    <option value="stadium">Stadium</option>
                    <option value="green_park">Green Park</option>
                    <option value="swimming_pool">Swimming Pool</option>
                    <option value="sports_centre">Sports Centre</option>
                    <option value="bus_stop">Bus Stop</option>
                </optgroup>
            </select>
            
            <button onclick="checkLocation()" id="confirm-btn" class="big-btn btn-confirm" disabled>
                I AM HERE!
            </button>
            <div class="text-xs text-center text-gray-500 mt-1" id="locked-msg">(Start turn to move)</div>
            
            <div class="grid grid-cols-2 gap-2 mt-3">
                <button onclick="resetPosition()" class="bg-blue-600 text-white text-xs font-bold py-2 rounded hover:bg-blue-500">
                    <i class="fas fa-undo mr-1"></i> Reset Pos
                </button>
                <button onclick="toggleBlindMode()" id="blind-btn" class="bg-gray-600 text-white text-xs font-bold py-2 rounded hover:bg-gray-500">
                    üëÅÔ∏è Hide Labels
                </button>
            </div>
            
            <div class="mt-2 text-center">
                 <button onclick="toggleDebug()" id="debug-btn" class="text-xs text-gray-500 hover:text-white underline">Toggle Debug Mode</button>
            </div>
        </div>
        
        <div class="mt-auto text-center text-gray-500 text-xs p-2">
            Use Arrow Keys to Move
        </div>
    </div>

    <!-- Main Game Display -->
    <div id="main-area">
        <div id="game-container">
            
            <!-- Road Names -->
            <div class="road-label road-v" style="top: 50%; left: 20%;">Station Road</div>
            <div class="road-label road-v" style="top: 50%; left: 54%;">Park Avenue</div>
            <div class="road-label road-v" style="top: 50%; left: 81%;">East Street</div>
            <div class="road-label" style="top: 32%; left: 50%;">Central Street</div>
            <div class="road-label" style="top: 61%; left: 35%;">Second Street</div>

            <!-- --- BUILDINGS (ICONS REMOVED) --- -->
            <!-- Left Side -->
            <div class="building b-industrial" style="top: 10%; left: 3%; width: 7%; height: 80%;" title="factory">
                Factory
            </div>
            <div class="building b-transport" style="top: 10%; left: 11%; width: 6%; height: 80%;" title="station">
                Station
            </div>
            <div style="position:absolute; top:35%; left:17%; font-size:0.7vw; color:#4b5563; font-weight:bold; transform:rotate(-90deg);">TAXI</div>

            <!-- Top Row -->
            <div class="building b-public" style="top: 5%; left: 24%; width: 10%; height: 23%; align-items: flex-start; padding:5px; background:#fff0e6;" title="library_block">
                <div class="building" style="top: 25%; left: 10%; width: 40%; height: 50%; border:none; background:transparent; box-shadow:none;" title="library">
                    Library
                </div>
                <div class="building" style="top: 5%; left: 55%; width: 40%; height: 30%; border:1px solid #ccc; background:#fff;" title="cafe">
                    Cafe
                </div>
                <div style="position:absolute; bottom:15%; right:10%; font-size:0.8vw; color:#4b5563;" title="main_square">Main Square</div>
            </div>
            <div class="building b-public" style="top: 5%; left: 53%; width: 11%; height: 23%;" title="government_building">
                Gov.<br>Building
            </div>
            <div class="building b-service" style="top: 5%; left: 64%; width: 10%; height: 23%;" title="post_office">
                Post<br>Office
            </div>
            <div class="building b-commercial" style="top: 5%; left: 74%; width: 7%; height: 23%;" title="hotel">
                Hotel
            </div>
            <div class="building b-commercial" style="top: 5%; left: 81%; width: 11%; height: 23%;" title="theatre">
                Theatre
            </div>

            <!-- Middle Row -->
            <div style="position: absolute; top: 38%; left: 24%; width: 27%; height: 20%;">
                <div class="building b-commercial" style="top: 0; left: 0; width: 40%; height: 50%;" title="department_store">
                    <span class="label-sm">Dept. Store</span>
                </div>
                <div class="building b-commercial" style="top: 50%; left: 0; width: 40%; height: 50%;" title="cinema">
                    Cinema
                </div>
                <div class="building b-commercial" style="top: 0; left: 40%; width: 60%; height: 25%;" title="supermarket">
                    <span class="label-sm">Supermarket</span>
                </div>
                <div class="building" style="top: 25%; left: 40%; width: 60%; height: 40%; background:#d1d5db;" title="car_park">
                    Car Park
                </div>
                <div class="building b-service" style="top: 65%; left: 40%; width: 30%; height: 35%;" title="bank">
                    <span class="label-sm">Bank</span>
                </div>
                <div class="building b-commercial" style="top: 65%; left: 70%; width: 30%; height: 35%;" title="book_shop">
                    <span class="label-sm">Book Shop</span>
                </div>
            </div>

            <div style="position: absolute; top: 38%; left: 58%; width: 22%; height: 20%;">
                <div class="building b-commercial" style="top: 25%; left: 0; width: 70%; height: 75%;" title="shopping_centre">
                    Shopping<br>Centre
                </div>
                <div class="building b-commercial" style="top: 0; left: 0; width: 25%; height: 25%;" title="sc_part1"></div>
                <div class="building b-commercial" style="top: 0; left: 25%; width: 20%; height: 25%;" title="sc_part2"></div>
                
                <div class="building b-commercial" style="top: 0; left: 45%; width: 25%; height: 25%;" title="shoe_shop">
                    <span class="label-sm">Shoe<br>Shop</span>
                </div>
                <div class="building b-commercial" style="top: 0; left: 70%; width: 30%; height: 25%;" title="chemist">
                    <span class="label-sm">Chemist</span>
                </div>
                <div class="building b-commercial" style="top: 25%; left: 70%; width: 30%; height: 37%;" title="sc_part3"></div>
                <div class="building b-commercial" style="top: 62%; left: 70%; width: 30%; height: 38%;" title="sc_part4"></div>
            </div>

            <!-- Bottom Row -->
            <div class="building b-park" style="top: 66%; left: 24%; width: 27%; height: 32%; align-items: flex-start; padding: 10px;" title="central_park">
                <div style="width: 100%; text-align: center; margin-bottom: 5px; font-weight:bold;">Central Park</div>
                <div class="building b-public" style="position: relative; top: 10%; left: 15%; width: 70%; height: 40%; border-color: #be185d;" title="museum">
                    Museum
                </div>
            </div>

            <div style="position: absolute; top: 66%; left: 58%; width: 22%; height: 32%; background: white; border: 2px solid #ccc; display: flex; justify-content: center; align-items: center;">
                <div class="building b-park" style="position: relative; width: 60%; height: 80%; border-radius: 40%; border: 4px solid #15803d; background: #86efac; display: flex; justify-content: center; align-items: center;" title="stadium">
                    <div style="color: #14532d; font-weight: bold;">STADIUM</div>
                </div>
            </div>

            <div class="building b-park" style="top: 38%; left: 84%; width: 15%; height: 28%;" title="green_park">
                Green<br>Park
            </div>
            <div style="position: absolute; top: 68%; left: 84%; width: 15%; height: 30%; border: 2px solid #4a5568; background: #fef3c7;">
                <div class="building b-service" style="top: 0; left: 0; width: 100%; height: 30%; background: #bae6fd; border:none; border-bottom: 1px solid #ccc;" title="swimming_pool">
                    <span class="label-sm">Swimming Pool</span>
                </div>
                <div class="building b-commercial" style="top: 30%; left: 0; width: 100%; height: 50%; background: transparent; border:none; box-shadow: none;" title="sports_centre">
                    <span class="label-sm">Sports Centre</span>
                </div>
                <div class="building" style="bottom: 0; left: 0; width: 100%; height: 20%; background: #e5e7eb; border-top: 2px solid #9ca3af; font-size: 0.7vw;" title="bus_stop">
                    Bus Stop
                </div>
            </div>

            <!-- Players (Two distinct elements) -->
            <div id="player-a" class="player-token"><i class="fas fa-user-astronaut"></i></div>
            <div id="player-b" class="player-token inactive"><i class="fas fa-user-ninja"></i></div>

            <!-- Monster Screen -->
            <div id="monster-screen" class="overlay-screen">
                <div class="text-9xl text-red-500 mb-4 animate-bounce"><i class="fas fa-skull-crossbones"></i></div>
                <h2 class="text-4xl font-bold text-red-500 font-['Press_Start_2P'] mb-4 text-center leading-relaxed">GAME OVER</h2>
                <p id="game-over-msg" class="text-xl text-gray-300 mb-8 text-center px-4 max-w-lg">Oh no! You have been kidnapped and taken to Cambodia!</p>
                <div class="flex gap-4">
                     <button onclick="retryTurn()" class="bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-500">Retry</button>
                    <button onclick="endTurn()" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-500 border-b-4 border-red-800">End Turn (Next Team)</button>
                </div>
            </div>

            <!-- Win Screen -->
            <div id="win-screen" class="overlay-screen">
                <div class="text-9xl text-yellow-300 mb-4 animate-pulse"><i class="fas fa-star"></i></div>
                <h2 class="text-5xl font-bold text-white font-['Press_Start_2P'] mb-4">CORRECT!</h2>
                <p class="text-2xl text-white mb-8">Good job!</p>
                <button onclick="endTurn()" class="bg-green-600 text-white font-bold py-4 px-8 rounded-full hover:bg-green-500 shadow-lg text-xl border-b-4 border-green-800 transition transform hover:scale-105">Finish Turn (Next Team)</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const locations = {
            "factory": { t: 10, l: 3, w: 7, h: 80 },
            "station": { t: 10, l: 11, w: 6, h: 80 },
            "library": { t: 10, l: 26, w: 8, h: 10 },
            "cafe": { t: 5, l: 45, w: 8, h: 10 },
            "main_square": { t: 15, l: 36, w: 16, h: 12 },
            "government_building": { t: 5, l: 53, w: 11, h: 23 },
            "post_office": { t: 5, l: 64, w: 10, h: 23 },
            "hotel": { t: 5, l: 74, w: 7, h: 23 },
            "theatre": { t: 5, l: 81, w: 11, h: 23 },
            "department_store": { t: 38, l: 24, w: 11, h: 10 },
            "cinema": { t: 48, l: 24, w: 11, h: 10 },
            "supermarket": { t: 38, l: 35, w: 16, h: 5 },
            "car_park": { t: 43, l: 35, w: 16, h: 8 },
            "bank": { t: 51, l: 35, w: 8, h: 7 },
            "book_shop": { t: 51, l: 43, w: 8, h: 7 },
            "shopping_centre": { t: 43, l: 58, w: 15, h: 15 },
            "shoe_shop": { t: 38, l: 68, w: 5, h: 5 },
            "chemist": { t: 38, l: 73, w: 7, h: 5 },
            "central_park": { t: 66, l: 24, w: 27, h: 32 },
            "museum": { t: 70, l: 28, w: 19, h: 13 },
            "stadium": { t: 66, l: 58, w: 22, h: 32 },
            "green_park": { t: 38, l: 84, w: 15, h: 28 },
            "swimming_pool": { t: 68, l: 84, w: 15, h: 9 },
            "sports_centre": { t: 77, l: 84, w: 15, h: 15 },
            "bus_stop": { t: 92, l: 84, w: 15, h: 6 }
        };

        // --- STATE ---
        let teamA = { x: 50, y: 90, el: document.getElementById('player-a') };
        let teamB = { x: 53, y: 90, el: document.getElementById('player-b') };
        
        let currentTurn = 'A';
        const speed = 0.5;
        let keysPressed = {};
        let scores = { A: 0, B: 0 };
        let debugMode = false;
        let blindMode = false;
        let animationFrameId;
        
        // Turn State
        let isTurnActive = false;
        
        // Timer Variables
        const TURN_TIME = 120; // 2 minutes
        let timeLeft = TURN_TIME;
        let timerInterval = null;

        // --- CORE FUNCTIONS ---
        function startTurn() {
            if (isTurnActive) return;
            isTurnActive = true;
            startTimer();
            updateUIState();
        }

        function startTimer() {
            stopTimer(); // Clear existing
            timeLeft = TURN_TIME;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    stopTimer();
                    handleTimeUp();
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timer-display');
            const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            display.innerText = `${m}:${s}`;
            
            if (timeLeft <= 30) {
                display.classList.add('low-time');
            } else {
                display.classList.remove('low-time');
            }
        }

        function handleTimeUp() {
            document.getElementById('game-over-msg').innerText = "Time's Up! The monster found you!";
            document.getElementById('monster-screen').classList.add('active');
        }

        function updateUIState() {
            const startBtn = document.getElementById('start-turn-btn');
            const confirmBtn = document.getElementById('confirm-btn');
            const lockedMsg = document.getElementById('locked-msg');
            
            if (isTurnActive) {
                startBtn.classList.add('hidden');
                confirmBtn.disabled = false;
                confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                lockedMsg.classList.add('hidden');
            } else {
                startBtn.classList.remove('hidden');
                confirmBtn.disabled = true;
                confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
                lockedMsg.classList.remove('hidden');
            }
        }

        function updateScoreboardUI() {
            document.getElementById('score-a').innerText = scores.A;
            document.getElementById('score-b').innerText = scores.B;
            
            const boxA = document.getElementById('box-a');
            const boxB = document.getElementById('box-b');
            const indicator = document.getElementById('turn-indicator');
            const playerAEl = teamA.el;
            const playerBEl = teamB.el;

            if (currentTurn === 'A') {
                boxA.classList.add('active'); boxB.classList.remove('active');
                indicator.innerText = "Turn: TEAM A";
                indicator.className = "text-xs bg-blue-900 px-2 py-1 rounded text-blue-200";
                
                playerAEl.classList.remove('inactive');
                playerBEl.classList.add('inactive');
                playerAEl.style.zIndex = 60; 
                playerBEl.style.zIndex = 40;
            } else {
                boxA.classList.remove('active'); boxB.classList.add('active');
                indicator.innerText = "Turn: TEAM B";
                indicator.className = "text-xs bg-pink-900 px-2 py-1 rounded text-pink-200";
                
                playerBEl.classList.remove('inactive');
                playerAEl.classList.add('inactive');
                playerBEl.style.zIndex = 60; 
                playerAEl.style.zIndex = 40;
            }
        }

        function adjustScore(team, amount) {
            scores[team] += amount;
            if (scores[team] < 0) scores[team] = 0; // Prevent negative scores? Optional
            updateScoreboardUI();
        }

        function endTurn() {
            stopTimer();
            isTurnActive = false;
            document.getElementById('monster-screen').classList.remove('active');
            document.getElementById('win-screen').classList.remove('active');
            
            // Switch Turn - Position is automatically preserved in teamA/teamB objects
            currentTurn = currentTurn === 'A' ? 'B' : 'A';
            
            updateScoreboardUI();
            updateUIState();
            // Reset timer display for next turn
            timeLeft = TURN_TIME;
            updateTimerDisplay();
        }

        function retryTurn() {
            stopTimer();
            // Keep turn active? Or require restart? Let's reset to start state for clarity
            isTurnActive = false;
            document.getElementById('monster-screen').classList.remove('active');
            updateUIState();
            timeLeft = TURN_TIME;
            updateTimerDisplay();
        }

        function resetScores() {
            stopTimer();
            isTurnActive = false;
            scores.A = 0; scores.B = 0; 
            currentTurn = 'A';
            
            teamA.x = 50; teamA.y = 90;
            teamB.x = 53; teamB.y = 90;
            updatePlayerVisuals();
            
            updateScoreboardUI(); 
            updateUIState();
            timeLeft = TURN_TIME;
            updateTimerDisplay();
        }

        function resetPosition() {
            // Only resets the ACTIVE team
            let activeTeam = currentTurn === 'A' ? teamA : teamB;
            activeTeam.x = currentTurn === 'A' ? 50 : 53;
            activeTeam.y = 90;
            updatePlayerVisuals();
        }

        function updatePlayerVisuals() {
            teamA.el.style.left = teamA.x + "%";
            teamA.el.style.top = teamA.y + "%";
            teamB.el.style.left = teamB.x + "%";
            teamB.el.style.top = teamB.y + "%";
        }

        function gameLoop() {
            // Only allow movement if turn is active
            if (!isTurnActive) {
                requestAnimationFrame(gameLoop);
                return;
            }

            let activeTeam = currentTurn === 'A' ? teamA : teamB;
            let moved = false;
            
            if (keysPressed['ArrowUp']) { activeTeam.y -= speed; moved = true; }
            if (keysPressed['ArrowDown']) { activeTeam.y += speed; moved = true; }
            if (keysPressed['ArrowLeft']) { activeTeam.x -= speed; moved = true; }
            if (keysPressed['ArrowRight']) { activeTeam.x += speed; moved = true; }

            if (moved) {
                if (activeTeam.x < 0) activeTeam.x = 0; if (activeTeam.x > 98) activeTeam.x = 98;
                if (activeTeam.y < 0) activeTeam.y = 0; if (activeTeam.y > 96) activeTeam.y = 96;
                
                activeTeam.el.style.left = activeTeam.x + "%";
                activeTeam.el.style.top = activeTeam.y + "%";
            }
            requestAnimationFrame(gameLoop);
        }

        function checkLocation() {
            if (!isTurnActive) return;

            const targetName = document.getElementById('target-select').value;
            const zone = locations[targetName];
            
            if(!zone) return;

            let activeTeam = currentTurn === 'A' ? teamA : teamB;
            const pX = activeTeam.x + 3.3; 
            const pY = activeTeam.y + 3.3; 

            const buffer = 5.0; 

            const inX = pX >= (zone.l - buffer) && pX <= (zone.l + zone.w + buffer);
            const inY = pY >= (zone.t - buffer) && pY <= (zone.t + zone.h + buffer);

            stopTimer(); // Pause timer while showing result

            if (inX && inY) {
                document.getElementById('winner-name').innerText = `TEAM ${currentTurn}`;
                document.getElementById('win-screen').classList.add('active');
            } else {
                document.getElementById('game-over-msg').innerText = "Oh no! You have been kidnapped and taken to Cambodia!";
                document.getElementById('monster-screen').classList.add('active');
            }
        }

        function toggleDebug() {
            debugMode = !debugMode;
            document.querySelectorAll('.building').forEach(el => {
                el.classList.remove('highlight-debug');
            });
            
            if (debugMode) {
                const targetName = document.getElementById('target-select').value;
                const el = document.querySelector(`.building[title="${targetName}"]`);
                if(el) el.classList.add('highlight-debug');
            }
            
            const btn = document.getElementById('debug-btn');
            btn.innerText = debugMode ? "Debug: ON" : "Toggle Debug Mode";
            btn.style.color = debugMode ? "#86efac" : "#6b7280";
        }

        function toggleBlindMode() {
            blindMode = !blindMode;
            const container = document.getElementById('game-container');
            const btn = document.getElementById('blind-btn');
            
            if (blindMode) {
                container.classList.add('blind-mode');
                btn.classList.replace('bg-gray-600', 'bg-purple-600');
                btn.classList.replace('hover:bg-gray-500', 'hover:bg-purple-500');
                btn.innerHTML = 'üëÅÔ∏è Show Labels';
            } else {
                container.classList.remove('blind-mode');
                btn.classList.replace('bg-purple-600', 'bg-gray-600');
                btn.classList.replace('hover:bg-purple-500', 'hover:bg-gray-500');
                btn.innerHTML = 'üëÅÔ∏è Hide Labels';
            }
        }

        // --- INPUT ---
        document.addEventListener('keydown', (e) => {
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault(); 
                // Only register key if turn is active
                if (isTurnActive) keysPressed[e.key] = true;
            }
            if (e.key === 'Enter') checkLocation();
        });
        document.addEventListener('keyup', (e) => {
            if (keysPressed[e.key]) delete keysPressed[e.key];
        });
        
        document.getElementById('target-select').addEventListener('change', (e) => {
            if(debugMode) {
                document.querySelectorAll('.highlight-debug').forEach(el => el.classList.remove('highlight-debug'));
                const el = document.querySelector(`.building[title="${e.target.value}"]`);
                if(el) el.classList.add('highlight-debug');
            }
        });

        // Init
        updatePlayerVisuals();
        updateScoreboardUI();
        updateUIState();
        requestAnimationFrame(gameLoop);

    </script>
</body>
</html>
